$(function(){function e(e,n,t){var i=$('<div style="height:25px;">');n.endsWith(".png")?i.append($('<div class="legend-img-box">').css("background-image","url("+n+")")):i.append($('<div class="legend-color-box">').css({backgroundColor:n})),i.append($("<span>").css("lineHeight","23px").html(t)),e.append(i)}function n(n){ue.empty(),be.text("  "+Publish.legend);var t=[];$.each(n,function(e){t.push(e)}),t.sort(),$.each(t,function(t,i){var o=n[i];e(ue,o,i)})}function t(e,t){var i="",o=" ",r=".",a=e.label,l=t||"Description",s=e.description||i,c=s.split(r),u=c[0]?c[0]+r:i,d=Ae+40,p=40*(Ue-d)/100,f=20*(Ue-d)/100;Ie.height()<p&&(f=30*(Ue-d)/100),Ie.css("max-height",p),me.css("max-height",f),ve.css("max-height",f),c.length-1>1?ze.show():ze.hide(),ge.text(o+l),he.text(u),Le.text(o+l),Oe.text(s),n(a)}function i(e){return{fillColor:e.getProperty("color"),strokeColor:e.getProperty("border"),strokeWeight:e.getProperty("width"),zIndex:e.getProperty("order"),icon:e.getProperty("icon")}}function o(e){var n=e.color;if(e.slices){var t=Object.keys(n).sort(function(e,n){return e-n}),i=t.map(Number);return function(e){var o=null;return $.each(i,function(i,r){e>=r&&(o=n[t[i]])}),o}}return function(e){return n[e]}}function r(e,n,t){var i=t.geom||e.getGeometry().getType(),r=re(t,1),a=o(t);if(!t.icon||i!==cn.Point&&i!==cn.MultiPoint){var l=r||n,s=t.color;"object"===$.type(s)?e.setProperty("color",a(e.getProperty(l))):e.setProperty("color",s),e.setProperty("border",t.border),e.setProperty("width",t.width)}else{var c=t.icon.options[e.getProperty(r)];c||(c=t.icon.path),e.setProperty("icon",c)}e.setProperty("order",t.order)}function a(e,n,t){e.setStyle(i),t.report&&e.addListener("click",function(e){if("function"===t.report){var i=e.feature.getProperty(re(t,0));"string"===$.type(i)&&(i=i.replace(/\s/g,"")),$("#modal-report-"+n+i).modal("show")}else $("#modal-report-"+n).modal("show")}),se[n]=e}function l(e,n,t){$.each(n,function(n,i){i.getVisible()?S(e,i):(M(e,i,t),w(e,me.hasClass("in"),ve.hasClass("in")))})}function s(e){return e.geom===cn.LineString}function c(e){return e.geom===cn.MultiLineString}function u(e){return s(e)||c(e)}function d(e,n,t){var i=n.visible,o=n.time?n.id:e;if("WMS"===n.geom){var r=new $.Deferred,a=n.time?e:n.name,l=new geoambiente.maps.WmsLayer({url:n.url,layer:a,visibility:i,opacity:n.transparency,map:ae});return r.resolve(l),se[e]=l,i&&oe(o,!0),ln||(ln=!0),t&&t(l),r.promise()}var s=Publish.path+e+".geojson";return $.getJSON(s,function(r){var a=new google.maps.Data;if(a.addGeoJson(r),u(n))L(a,e,n);else{if(O(a,e,n),i)if(oe(o,!0),n.time){var l=n.name.indexOf(e);0===l&&a.setMap(ae)}else a.setMap(ae);t&&t(a)}})}function p(e,n){e.setMap(null),oe(n,!1)}function f(e,n){e.setMap(ae),oe(n,!0),w(n,me.hasClass("in"),ve.hasClass("in"))}function h(){var e=Qe[0],n=Qe[1];if(null!==e&&void 0!==e&&null!==n&&void 0!==n)for(var t=e;t<=n;t++)Y(t)}function m(e,n,t){var i=e.icon.time;s(e)?l(n,t,i):$.each(t,function(e,t){l(n,t,i)})}function v(e,n){Xe[e]?p(n,e):f(n,e)}function g(e){Xe[e]?oe(e,!1):(oe(e,!0),w(e,me.hasClass("in"),ve.hasClass("in"))),h()}function b(e){var n=Publish.data[e];if(n.time)g(e);else{var t=se[e];t?u(n)?m(n,e,t):v(e,t):(I(),fe.empty(),z(e,1,1),n.visible=!0,d(e,n).done(function(){w(e,me.hasClass("in"),ve.hasClass("in"))}).always(function(){W()}))}}function y(e,n){le=null,ue.empty(),he.empty(),ge.text(" Description"),we.hide(),$("button").removeClass("button-selected"),e&&(ge.click(),ge.prop("disabled",!0)),n&&(be.click(),be.prop("disabled",!0))}function w(e,n,i){le=e;var o=Publish.data[e];if(t(o,ce[e]),n||(ge.prop("disabled",!1),ge.click()),i||(be.prop("disabled",!1),be.click()),o.download){var r=e+".zip";ye.prop("href",Publish.path+r),ye.prop("download",r),we.show()}else we.hide();Ve.removeClass("button-selected"),$("#"+e).addClass("button-selected")}function P(e){var n=e.target.id;if(n){var t=me.hasClass("in"),i=ve.hasClass("in");le===n?y(t,i):w(n,t,i)}}function x(e){var n=e.target.name;if(n){var t=Publish.group;if(t){var i=Publish.data[n].group,o=t[i];o?(b(o),o===n?t[i]=null:(t[i]=n,b(n))):(t[i]=n,b(n))}else b(n);E()}}function C(e,n,t){var i=0,o=setInterval(function(){i=(i+1)%200;var e=n.get("icons");e[0].offset=i/2+"%",n.set("icons",e)},t);window.intervals||(window.intervals={}),window.intervals[e]||(window.intervals[e]=[]),window.intervals[e].push(o)}function k(e,n){var t=e.icon.options,i=[];n.forEachLatLng(function(e){i.push(e)});var o={path:t.path,anchor:new google.maps.Point(175,175),scale:.1,fillColor:t.fillColor,fillOpacity:t.fillOpacity,strokeWeight:t.strokeWeight},r={path:i,icons:[{icon:o}],strokeWeight:e.width,strokeColor:e.border||e.color,strokeOpacity:e.transparency};return new google.maps.Polyline(r)}function M(e,n,t){n.setMap(ae),n.setVisible(!0),C(e,n,t)}function S(e,n){n.setMap(null),n.setVisible(!1),window.intervals&&$.each(window.intervals[e],function(e,n){clearInterval(n)})}function L(e,n,t){var i=[],o=t.visible,r=t.icon.time;e.forEach(function(e){var a=e.getGeometry();if(s(t)){var l=k(t,a);i.push(l),o&&M(n,l,r)}else if(c(t)){var u=[];$.each(a.getArray(),function(e,i){var a=k(t,i);u.push(a),o&&M(n,a,r)}),i.push(u)}}),se[n]=i,o&&oe(n,!0)}function O(e,n,t){e.forEach(function(e){r(e,n,t)}),a(e,n,t)}function T(e,n,t){return"Loading"+ce[e]+" ("+n+"/"+t+")"}function z(e,n,t){var i=T(e,n,t);fe.text(i)}function I(){de.fadeIn(),pe.css("z-index",1e7)}function W(){de.fadeOut(),fe.empty(),pe.css("z-index",-1)}function D(e,n){function t(e,n,t){return Math.floor(Math.log(e/n/t)/Math.LN2)}if("number"===$.type(e))return e;var i=t(Ue,e.yTile,e.latFraction),o=t(Te.width(),e.xTile,e.longFraction);return Math.min(i,o,n)}function V(e){var n=[];return $.each(e,function(e,t){n.push(t)}),n}function G(e){var n=[],t=0,i=Object.keys(e).length,o=!1,l="creation";I(),$.each(e,function(e,s){ie(s);var c=s.visible,u=s.time;if(s.scenario&&(nn[e]=!0,an||(an=!0)),!c&&!u)return!0;if(t+=1,fe.empty(),z(e,t,i),u){var p=0;if(u===l){var f=Publish.path+e+".geojson";n.push($.getJSON(f,function(n){var t=new google.maps.Data;t.addGeoJson(n);var i={};$.each(s.timeline,function(e,n){i[n]=new google.maps.Data});var o=s.name;t.forEach(function(n){r(n,e,s);var t=n.getProperty(o),a=i[t];a&&a.add(n)}),s.name=[],$.each(i,function(n,t){var i=e+"_"+n;a(t,i,s),R(n,t,e,u),s.name.push(i),p++,c&&(oe(e,!0),0===p&&t.setMap(ae))})}))}else $.each(s.name,function(t,i){var o=s.timeline[p];n.push(d(i,s,function(n){R(o,n,e,u)})),p++});!rn&&c&&(rn=!0,o=!0)}else n.push(d(e,s))});var s=me.hasClass("in"),c=ve.hasClass("in"),u=Ve[0].id;w(u,s,c),$.when.apply($,n).always(function(){o&&rn&&(j(),tn.timelineYears=V(Ke),tn.timelineLayers=V(qe),tn.backup=V(Ke)),W()})}function N(){google.maps.visualRefresh=!0;var e={center:new google.maps.LatLng(Publish.center.lat,Publish.center.long),zoom:D(Publish.zoom,Publish.maxZoom),minZoom:Publish.minZoom,maxZoom:Publish.maxZoom,mapTypeId:google.maps.MapTypeId[Publish.mapTypeId],mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.TOP_RIGHT}};ae=new google.maps.Map(Te[0],e),ae.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push($("#footer")[0]),X(),google.maps.event.addListenerOnce(ae,"idle",function(){G(Publish.data)})}function j(){Ne.slider({range:!0,min:0,max:Ke.length-1,step:1,values:[0,Ke.length-1]}).each(J).on("slide",Z),E()}function E(){if(rn)if(B())Ye||(Ye=je.detach());else{var e=H();e&&null!==Ye?(Ye.appendTo(Ee),Ye=null):e||null!==Ye||(Ye=je.detach())}}function Y(e){$.each(qe,function(n,t){var i=null;Xe[t.type]&&t.year===Ke[e]&&(i=ae),t.layer.setMap(i)})}function Z(e,n){var t=Ke.length-1,i=n.values[1],o=i/t*100-1||0;Ze.css("left",o+"%"),Qe=n.values,Y(i)}function J(){var e=0,n=Ke.length,t=n-1;if(Qe=[0,t],$.each(Ke,function(n,i){var o=e/t*100||0,r=$("<label>"+i+"</label>").css("left",o+"%");Ne.append(r),e++}),n>0){var i=6,o=100/n;if(o<i){var r=.6*Te.width(),a=je.width(),l=a*(i/o);l>r&&(l=r),je.width(l)}}}function R(e,n,t,i,o){var r=A(e),a=F(e);r?_(t,n,e,i,o):(Ke.splice(a,0,e),_(t,n,e,i,o))}function _(e,n,t,i,o){qe.push({type:e,layer:n,year:t,time:i,scenario:o})}function F(e){var n=0;return $.each(Ke,function(t,i){return i===e?t:e<i?t:void n++}),n}function H(){var e=!1;return rn&&qe.length>0&&$.each(qe,function(n,t){if(Xe[t.type])return e=!0,!1}),e}function B(){return 1===Ke.length}function A(e){var n=!1;return $.each(Ke,function(t,i){i===e&&(n=!0)}),n}function U(){function e(){Ze.css("left",i/t*100-1+"%"),Y(i),i++}function n(){De.prop("disabled",!1),Ve.click(P),Ge.prop("disabled",!1),Ne.slider("enable")}De.prop("disabled",!0),Ve.off("click"),Ge.prop("disabled",!0),Ne.slider("disable");var t=Ke.length-1,i=Qe[0],o=Qe[1],r=null,a=null;ln?(a=function(){i<=o?(google.maps.event.addListenerOnce(ae,"tilesloaded",function(){setTimeout(a,sn)}),e()):n()})():(a=function(){i<=o?e():(clearInterval(r),n())},r=setInterval(a,sn))}function q(){var e=!1;return an&&$.each(Xe,function(n,t){if(t&&nn[n])return e=!0,!1}),e}function K(){if(tn.currentScenario){var e=Publish.data[tn.currentView],n=e.scenario[tn.currentScenario];$.each(n.name,function(e,n){var t=se[n];t.setMap(null)}),Ke=V(tn.timelineYears),qe=V(tn.timelineLayers),tn.currentScenario=null,tn.currentView=null}}function Q(){K();var e="",n=$("#scenarioSeparator"),t=Je.find("option:selected").text().trim(),i=Je.find("option:selected").val();if(i){t=Publish.scenarioWrapper[t],0===n.length&&(n=$('<br id="scenarioSeparator"/>'),n.insertBefore(Re));var o=on[t];if(o)Ke=V(o.timelineYears),qe=V(o.timelineLayers),tn.currentScenario=t,tn.currentView=i,Ne.find("label").remove(),j(),h();else{var r=[],a=Publish.data[i],l=a.scenario[t];I();var s=0,c=a.time;$.each(l.name,function(e,n){var o=l.timeline[s];r.push(d(n,a,function(e){R(o,e,i,c,t)})),s++}),$.when.apply($,r).always(function(){tn.currentScenario=t,tn.currentView=i,on[t]={timelineYears:V(Ke),timelineLayers:V(qe)},Ne.find("label").remove(),j(),W(),h()})}var u=" ",p=".",f=Publish.scenario[t],m=f.split(p),v=m[0]?m[0]+p:e;m.length-1>1?_e.show():_e.hide(),Re.text(v),He.text(u+t),Be.text(f)}else Ne.find("label").remove(),j(),h(),n.length>0&&n.remove(),Re.text(e),_e.hide()}function X(){De.each(function(e,n){en[n.name]=$(n)}),Ve.each(function(e,n){ce[n.id]=n.innerText,Xe[n.id]=!1}),De.click(x),Ve.click(P),Ge.click(U),Je.change(Q),ge.prop("disabled",!0),be.prop("disabled",!0),$e.text("  "+Publish.layers),we.hide()}function ee(){if(Pe.is(":visible"))Te.find(".ol-zoom").css("margin-left",0).removeClass("zoom-top-opened-sidebar").addClass("zoom-top-collapsed");else{var e=$(".sidebar-left");Te.find(".ol-zoom").css("margin-left",e.width()).removeClass("zoom-top-opened-sidebar").removeClass("zoom-top-collapsed")}}function ne(){return xe.width()===$(window).width()}function te(){if(ne()&&(Ce.fadeOut("slide"),Pe.fadeIn()),$("#logo")){var e=50,n=Ae-e;$("body").css("padding-top",n),Pe.css("margin-top",n)}var t=Publish.fontSize;if(t){var i=$(".custom-font-layer"),o=$(".custom-font-app-title"),r=$(".custom-font-group-title"),a=$(".custom-font-report-title"),l=$(".custom-font-subtitle"),s=$(".custom-font-body"),c=$(".custom-font-legend"),u=$(".custom-font-more "),d="px",p="font-size",f=function(e){return parseFloat(e.css(p))},h=function(e,n){e.css(p,n+d)},m=f(i),v=function(e){var n=f(e)-m,i=t+n;h(e,i)};h(i,t),v(o),v(r),v(a),v(l),v(s),v(c),v(u)}}function ie(e){if(!e.label){e.label={};var n="rgba(0, 0, 0, 1)";e.label[e.id]=e.color||e.border||n}}function oe(e,n){Xe[e]!==n&&(Xe[e]=n,an&&e===tn.currentView&&Je.val("").change(),en[e].prop("checked",n)),an&&(q()?Je.prop("disabled",!1):Je.prop("disabled",!0))}function re(e,n){return"array"===$.type(e.select)?e.select[n]:e.select}var ae,le,se={},ce={},ue=$("#legend"),de=$("#loader"),pe=$("#loader-message"),fe=$("#loader-message-text"),he=$("#layer-description"),me=$("#properties"),ve=$("#legends"),ge=$("#description-title"),be=$("#legend-title"),$e=$("#layers-title"),ye=$("#download-title"),we=$("#panel-download"),Pe=$(".mini-submenu-left"),xe=$(".sidebar"),Ce=$(".sidebar-left .sidebar-body"),ke=$(".sidebar-left .slide-submenu"),Me=$("#modal-app-description"),Se=$("#modal-completed-description"),Le=$("#modal-title-description"),Oe=$("#info-description"),Te=$("#map"),ze=$("#more"),Ie=$("#layers"),We=Ie.find("label"),De=We.find("input"),Ve=We.find("a"),Ge=$("#play"),Ne=$("#slider"),je=$("#slider-container"),Ee=$("#slider-col"),Ye=null,Ze=$("#spanSelectedYear"),Je=$("#scenario-combobox"),Re=$("#scenario-description"),_e=$("#more-scenario-description"),Fe=$("#modal-scenario-completed-description"),He=$("#modal-scenario-title-description"),Be=$("#scenario-info-description"),Ae=$(".navbar").height(),Ue=Te.height(),qe=[],Ke=[],Qe=[],Xe={},en={},nn={},tn={},on={},rn=!1,an=!1,ln=!1,sn=Publish.interval||1e3,cn={Point:"Point",MultiPoint:"MultiPoint",LineString:"LineString",MultiLineString:"MultiLineString",WMS:"WMS"};google.maps.event.addDomListener(window,"load",N),ke.on("click",function(){var e=$(this);e.closest(".sidebar-body").fadeOut("slide",function(){Pe.fadeIn(),ee()})}),Pe.on("click",function(){var e=$(this);Ce.toggle("slide"),e.hide(),ee()}),ze.on("click",function(){Se.modal("show")}),_e.on("click",function(){Fe.modal("show")}),$(window).on("resize",ee),Me.modal("show"),te(),ee()});